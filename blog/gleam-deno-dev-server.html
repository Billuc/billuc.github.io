<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>Billaud Luc - Website</title>
		<link rel="icon" href="../luc.webp" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="Billuc's website, developped by Luc Billaud" />
		
		<link href="../_app/immutable/assets/index.ZJaHuitq.css" rel="stylesheet">
		<link href="../_app/immutable/assets/0.wNYfsyYx.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.Z93z0FaC.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/maf76e2w.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/LQZmqQ7L.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BUApaBEI.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/P8P3Fy7Z.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.BQofsKFK.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/PPVm8Dsz.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/D7nt4fav.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Dg1k8eVS.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/mLSCvt70.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/D_KeOYJ0.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.aDvz2hjX.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C99na2Y6.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DW57CB9H.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/_yZx2JSC.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Bj8lqxZw.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CGvfxUZK.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Dj_lqk8O.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/5.g1mquR-N.js">
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><!----><main><div><div class="text-slate-900 flex flex-row w-full relative"><div class="fixed top-4 left-4 block md:hidden w-8 h-8 shadow-md cursor-pointer" role="button" tabindex="0"><div id="profile" class="flex flex-col flex-nowrap justify-center items-center"><img alt="" src="/_app/immutable/assets/luc2.D84-XoRd.jpg" class="shadow-xl rounded-xl svelte-1mytxqo"/></div><!----></div> <div class="fixed md:relative top-0 left-0 bg-slate-900 text-slate-50 z-10 max-w-[80%] md:min-w-xs md:max-w-xs transition-transform duration-300 -translate-x-full md:translate-x-0"><div class="sticky top-0 left-0 p-8 h-screen overflow-auto"><div id="profile" class="flex flex-col flex-nowrap justify-center items-center"><img alt="" src="/_app/immutable/assets/luc2.D84-XoRd.jpg" class="shadow-xl rounded-xl svelte-1mytxqo"/></div><!----> <div class="text-center"><div class="text-xl font-black my-4">Luc Billaud</div> <div class="text-sm my-2">Curious developer and open-source lover.</div></div> <div class="my-8"><a href="/" class="flex flex-row items-center px-8 py-0.5 border-sky-200 border-t last:border-b border-opacity-30 hover:text-red-300"><button class="
		 rounded
		w-8 h-8 flex justify-center items-center 
		"><!--[--><svg class="svelte-fa svelte-fa-base  svelte-q6zoq1" viewBox="0 0 512 512" aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg"><!--[!--><!--]--><g transform="translate(256 256)" transform-origin="128 0" class="svelte-q6zoq1"><g transform="translate(0,0) scale(1,1)" class="svelte-q6zoq1"><!--[--><path d="M277.8 8.6c-12.3-11.4-31.3-11.4-43.5 0l-224 208c-9.6 9-12.8 22.9-8 35.1S18.8 272 32 272l16 0 0 176c0 35.3 28.7 64 64 64l288 0c35.3 0 64-28.7 64-64l0-176 16 0c13.2 0 25-8.1 29.8-20.3s1.6-26.2-8-35.1l-224-208zM240 320l32 0c26.5 0 48 21.5 48 48l0 96-128 0 0-96c0-26.5 21.5-48 48-48z" fill="currentColor" transform="translate(-256 -256)" class="svelte-q6zoq1"></path><!--]--></g></g></svg><!--]--><!----></button><!----> <div class="overflow-clip ml-2"><!---->Home<!----></div></a><!---->  <a href="/projects" class="flex flex-row items-center px-8 py-0.5 border-sky-200 border-t last:border-b border-opacity-30 hover:text-red-300"><button class="
		 rounded
		w-8 h-8 flex justify-center items-center 
		"><!--[--><svg class="svelte-fa svelte-fa-base  svelte-q6zoq1" viewBox="0 0 448 512" aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg"><!--[!--><!--]--><g transform="translate(224 256)" transform-origin="112 0" class="svelte-q6zoq1"><g transform="translate(0,0) scale(1,1)" class="svelte-q6zoq1"><!--[--><path d="M288 0L128 0C110.3 0 96 14.3 96 32s14.3 32 32 32L128 215.5 7.5 426.3C2.6 435 0 444.7 0 454.7 0 486.4 25.6 512 57.3 512l333.4 0c31.6 0 57.3-25.6 57.3-57.3 0-10-2.6-19.8-7.5-28.4L320 215.5 320 64c17.7 0 32-14.3 32-32S337.7 0 320 0L288 0zM192 215.5l0-151.5 64 0 0 151.5c0 11.1 2.9 22.1 8.4 31.8l41.6 72.7-164 0 41.6-72.7c5.5-9.7 8.4-20.6 8.4-31.8z" fill="currentColor" transform="translate(-224 -256)" class="svelte-q6zoq1"></path><!--]--></g></g></svg><!--]--><!----></button><!----> <div class="overflow-clip ml-2"><!---->Projects<!----></div></a><!----> <a href="/blog" class="flex flex-row items-center px-8 py-0.5 border-sky-200 border-t last:border-b border-opacity-30 hover:text-red-300"><button class="
		 rounded
		w-8 h-8 flex justify-center items-center 
		"><!--[--><svg class="svelte-fa svelte-fa-base  svelte-q6zoq1" viewBox="0 0 640 512" aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg"><!--[!--><!--]--><g transform="translate(320 256)" transform-origin="160 0" class="svelte-q6zoq1"><g transform="translate(0,0) scale(1,1)" class="svelte-q6zoq1"><!--[--><path d="M128.1 0c-35.3 0-64 28.7-64 64l0 384c0 35.3 28.7 64 64 64l146.2 0 10.9-54.5c4.3-21.7 15-41.6 30.6-57.2l132.2-132.2 0-97.5c0-17-6.7-33.3-18.7-45.3L322.8 18.7C310.8 6.7 294.5 0 277.6 0L128.1 0zM389.6 176l-93.5 0c-13.3 0-24-10.7-24-24l0-93.5 117.5 117.5zM332.3 466.9l-11.9 59.6c-.2 .9-.3 1.9-.3 2.9 0 8 6.5 14.6 14.6 14.6 1 0 1.9-.1 2.9-.3l59.6-11.9c12.4-2.5 23.8-8.6 32.7-17.5l118.9-118.9-80-80-118.9 118.9c-8.9 8.9-15 20.3-17.5 32.7zm267.8-123c22.1-22.1 22.1-57.9 0-80s-57.9-22.1-80 0l-28.8 28.8 80 80 28.8-28.8z" fill="currentColor" transform="translate(-320 -256)" class="svelte-q6zoq1"></path><!--]--></g></g></svg><!--]--><!----></button><!----> <div class="overflow-clip ml-2"><!---->Blog<!----></div></a><!----></div> <div class="flex justify-center my-2"><!--[--><a href="https://github.com/Billuc" class="px-0.5 py-0.5 hover:text-red-300"><button class="
		 rounded
		w-8 h-8 flex justify-center items-center 
		"><!--[--><svg class="svelte-fa svelte-fa-base  svelte-q6zoq1" viewBox="0 0 512 512" aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg"><!--[!--><!--]--><g transform="translate(256 256)" transform-origin="128 0" class="svelte-q6zoq1"><g transform="translate(0,0) scale(1,1)" class="svelte-q6zoq1"><!--[--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3 .3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5 .3-6.2 2.3zm44.2-1.7c-2.9 .7-4.9 2.6-4.6 4.9 .3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM252.8 8c-138.7 0-244.8 105.3-244.8 244 0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1 100-33.2 167.8-128.1 167.8-239 0-138.7-112.5-244-251.2-244zM105.2 352.9c-1.3 1-1 3.3 .7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3 .3 2.9 2.3 3.9 1.6 1 3.6 .7 4.3-.7 .7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3 .7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3 .7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z" fill="currentColor" transform="translate(-256 -256)" class="svelte-q6zoq1"></path><!--]--></g></g></svg><!--]--><!----></button><!----></a><a href="https://www.linkedin.com/in/luc-billaud" class="px-0.5 py-0.5 hover:text-red-300"><button class="
		 rounded
		w-8 h-8 flex justify-center items-center 
		"><!--[--><svg class="svelte-fa svelte-fa-base  svelte-q6zoq1" viewBox="0 0 448 512" aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg"><!--[!--><!--]--><g transform="translate(224 256)" transform-origin="112 0" class="svelte-q6zoq1"><g transform="translate(0,0) scale(1,1)" class="svelte-q6zoq1"><!--[--><path d="M416 32L31.9 32C14.3 32 0 46.5 0 64.3L0 447.7C0 465.5 14.3 480 31.9 480L416 480c17.6 0 32-14.5 32-32.3l0-383.4C448 46.5 433.6 32 416 32zM135.4 416l-66.4 0 0-213.8 66.5 0 0 213.8-.1 0zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77zM384.3 416l-66.4 0 0-104c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9l0 105.8-66.4 0 0-213.8 63.7 0 0 29.2 .9 0c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9l0 117.2z" fill="currentColor" transform="translate(-224 -256)" class="svelte-q6zoq1"></path><!--]--></g></g></svg><!--]--><!----></button><!----></a><a href="mailto:luc.billaud.pro@gmail.com" class="px-0.5 py-0.5 hover:text-red-300"><button class="
		 rounded
		w-8 h-8 flex justify-center items-center 
		"><!--[--><svg class="svelte-fa svelte-fa-base  svelte-q6zoq1" viewBox="0 0 512 512" aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg"><!--[!--><!--]--><g transform="translate(256 256)" transform-origin="128 0" class="svelte-q6zoq1"><g transform="translate(0,0) scale(1,1)" class="svelte-q6zoq1"><!--[--><path d="M48 64c-26.5 0-48 21.5-48 48 0 15.1 7.1 29.3 19.2 38.4l208 156c17.1 12.8 40.5 12.8 57.6 0l208-156c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48L48 64zM0 196L0 384c0 35.3 28.7 64 64 64l384 0c35.3 0 64-28.7 64-64l0-188-198.4 148.8c-34.1 25.6-81.1 25.6-115.2 0L0 196z" fill="currentColor" transform="translate(-256 -256)" class="svelte-q6zoq1"></path><!--]--></g></g></svg><!--]--><!----></button><!----></a><!--]--></div></div></div>  <div class="fixed top-0 left-0 w-screen h-screen bg-slate-900 opacity-50 cursor-pointer hidden"></div><!----> <div class="min-h-screen grow max-w-full md:max-w-screen--xs bg-slate-100 flex flex-col justify-between"><div class="w-11/12 mx-auto py-6 grow flex"><!----><div class="py-16 text-center w-full"><article class="flex flex-col items-center"><span class="text-4xl font-black text-slate-900">A custom dev server with file watching in Gleam using Deno</span> <div class="my-4 border-b-2 border-red-600 border-opacity-30 w-40"></div> <p class="text-sm italic mb-8">Published: 02/01/2026, last updated: 02/01/2026</p> <div class="px-4 md:px-10 lg:px-20 mx-auto self-stretch text-justify prose md:my-prose-lg max-w-full"><!----><p>After the work on gleaxml in <a href="./gleam-xml-parser-benchmark">the previous blog post</a>, I wanted to update my RSS reader website to use
the most performant parser and change a few things in the layout and style of the website. Since the website
is thought to be served by an AWS Lambda, it is 100% server-side rendered and it is done in a very basic
fashion: generate a <a href="https://hexdocs.pm/lustre/index.html" rel="nofollow">Lustre</a> Element, convert it to a string using <code>to_string</code> or <code>to_document_string</code>,
wrap it in an object with the form expected by AWS and return it. This works really well in “production” but
the code I generated was only a handler that would be called by AWS Lambda’s framework and not an actual server
that I could use for local development.</p> <h2>Creating a dev server for AWS Lambdas</h2> <p>Here, the solution was quite simple: find a web server, write some code to convert the objects provided by
the server to object expected by the handler and vice-versa and connect my AWS handler at the end of it.
Since the handler runs on AWS’s Javascript runtime, I needed a JS web server. Fortunately, I found one in <a href="https://packages.gleam.run" rel="nofollow">Gleam packages</a> called <a href="https://hexdocs.pm/glen/index.html" rel="nofollow">glen</a>. It is actually a wrapper around Deno’s <code>serve</code> function
and the code is well-written, the API is nice and it supports WebSockets.</p> <p>Here is what the logic looks like:</p> <!----><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff" tabindex="0"><code><span class="line"><span style="color:#81A1C1">fn</span><span style="color:#88C0D0"> run_dev_server</span><span style="color:#D8DEE9FF">() &#123;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  node.</span><span style="color:#88C0D0">console_log</span><span style="color:#D8DEE9FF">(</span><span style="color:#A3BE8C">"Starting development server on http://localhost:1212"</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">  glen.</span><span style="color:#88C0D0">serve</span><span style="color:#D8DEE9FF">(</span><span style="color:#B48EAD">1212</span><span style="color:#D8DEE9FF">, glen_handler)</span></span>
<span class="line"><span style="color:#D8DEE9FF">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">fn</span><span style="color:#88C0D0"> glen_handler</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">request: </span><span style="color:#D8DEE9FF">glen.Request) </span><span style="color:#81A1C1">-></span><span style="color:#D8DEE9FF"> promise.Promise(glen.Response) &#123;</span></span>
<span class="line"><span style="color:#88C0D0">  request_to_event</span><span style="color:#D8DEE9FF">(request)</span></span>
<span class="line"><span style="color:#81A1C1">  |></span><span style="color:#D8DEE9FF"> promise.</span><span style="color:#88C0D0">await</span><span style="color:#D8DEE9FF">(rss_reader.handler)</span></span>
<span class="line"><span style="color:#81A1C1">  |></span><span style="color:#D8DEE9FF"> promise.</span><span style="color:#88C0D0">map</span><span style="color:#D8DEE9FF">(response_to_glen)</span></span>
<span class="line"><span style="color:#D8DEE9FF">&#125;</span></span></code></pre><!----> <blockquote><p>Note: This code is located in ‘dev/rss_reader_dev.gleam’. I originally put it in ‘src/rss_reader_dev.gleam’,
but there were some problems with dev-only dependencies which are not accessible to code located in ‘src’.
I couldn’t find a doc on the ‘dev’ folder on the Gleam website, but found some information on the Gleam
Discord server !</p></blockquote> <p>The <code>request_to_event</code> and <code>response_to_glen</code> functions are pretty simple.<br/> The first one takes a <code>glen.Request</code> object and encodes it into a <code>dynamic.Dynamic</code> object with the properties
expected by the handler. Most of them are provided in the <code>Request</code> object such as the path,
the query string, the HTTP method, but some were specific to the AWS context, such as the accountId or the
requestId, so I filled them with placeholder data.<br/> The second takes the <code>dynamic.Dynamic</code> object returned by the handler and decodes it to create a <code>glen.Response</code>.
We simply takes the status code, headers and body from the data and create a <code>Response</code> with it and that is
basically it !</p> <h2>Making it rebuild automatically</h2> <p>This server functions really well but has a major flaw. When I started to change the CSS code, I had to stop the server,
rebuild the project, restart the server and reload the page to see the change applied. This became frustating quite
quickly so instead of forcing my way through and finishing the CSS code in a few hours, I decided to spend a whole day
setting up some code that would automatically rebuild the project and restart the server whenever I made a change to the
code. And it was worth it !</p> <p>The principle is this: have a piece of code watch the folder containing the code (1) and whenever changes are made,
rebuild the project (2) and restart the server with the new code (3). Let’s start with step 1 !</p> <h3>Watching the code</h3> <p>Since glen was based on Deno, I have the whole power of Deno at my hands and Deno has a plethora of cool utilities !
Fortunately Deno exposes the function <a href="https://docs.deno.com/api/deno/~/Deno.watchFs" rel="nofollow">Deno.watchFs</a> whose job is to,
well, watch the filesystem at a specified location. So I wrote a simple FFI code that would watch a provided path and call
a callback whenever a change is made to a file.</p> <!----><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff" tabindex="0"><code><span class="line"><span style="color:#81A1C1">export</span><span style="color:#81A1C1"> async</span><span style="color:#81A1C1"> function</span><span style="color:#88C0D0"> deno_watch</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">path</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> onEvent</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> &#123;</span></span>
<span class="line"><span style="color:#81A1C1">	let</span><span style="color:#D8DEE9"> watcher</span><span style="color:#81A1C1"> =</span><span style="color:#D8DEE9"> Deno</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">watchFs</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">path</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">	for</span><span style="color:#81A1C1"> await</span><span style="color:#D8DEE9FF"> (</span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9"> event</span><span style="color:#81A1C1"> of</span><span style="color:#D8DEE9"> watcher</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">&#123;</span></span>
<span class="line"><span style="color:#81A1C1">		await</span><span style="color:#88C0D0"> onEvent</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">event</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#ECEFF4">	&#125;</span></span>
<span class="line"><span style="color:#ECEFF4">&#125;</span></span></code></pre><!----> <p>Here onEvent would be something like this:</p> <!----><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff" tabindex="0"><code><span class="line"><span style="color:#81A1C1">fn</span><span style="color:#88C0D0"> on_event</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">ctx: </span><span style="color:#D8DEE9FF">DevContext, </span><span style="color:#616E88">_event</span><span style="color:#D8DEE9FF">) </span><span style="color:#81A1C1">-></span><span style="color:#D8DEE9FF"> promise.Promise(DevContext) &#123;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  node.</span><span style="color:#88C0D0">console_log</span><span style="color:#D8DEE9FF">(</span><span style="color:#A3BE8C">"Changes detected, rebuilding..."</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0">  rebuild</span><span style="color:#D8DEE9FF">()</span></span>
<span class="line"><span style="color:#81A1C1">  |></span><span style="color:#D8DEE9FF"> promise.</span><span style="color:#88C0D0">await</span><span style="color:#D8DEE9FF">(</span><span style="color:#81A1C1">fn</span><span style="color:#D8DEE9FF">(</span><span style="color:#616E88">_</span><span style="color:#D8DEE9FF">) &#123;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    node.</span><span style="color:#88C0D0">console_log</span><span style="color:#D8DEE9FF">(</span><span style="color:#A3BE8C">"Rebuild succeeded ! Restarting server..."</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#88C0D0">    restart_server</span><span style="color:#D8DEE9FF">(ctx)</span></span>
<span class="line"><span style="color:#D8DEE9FF">  &#125;)</span></span>
<span class="line"><span style="color:#D8DEE9FF">&#125;</span></span></code></pre><!----> <p><code>rebuild</code> was easy to implement: use <a href="https://hexdocs.pm/shellout/" rel="nofollow">shellout</a> or <a href="https://docs.deno.com/api/deno/~/Deno.Command" rel="nofollow">Deno.Command</a> to spawn a process running <code>gleam build</code> and wait for it to complete. I ended up using <code>Deno.Command</code> to avoid
having one more dependency.</p> <p><code>restart_server</code> however gave me a lot more headaches.</p> <h3>Restarting the server</h3> <p>At first, I used a naive approach. I stored a reference to the <a href="https://docs.deno.com/api/deno/~/Deno.HttpServer" rel="nofollow">server</a> in the context,
closed it and created a new one after the build completed. As you can guess, this approach did not work because it didn’t use
the freshly built code. The reason why is because we didn’t restart the process, so the new code isn’t loaded in memory, only the old code.</p> <p>Alright, so I have to create a new <strong><em>process</em></strong> and not a new <strong><em>server</em></strong> when I call <code>restart_server</code>. Fortunately, I have a simple way
to start a dev server <strong><em>process</em></strong> via <code>gleam dev run</code>. So I wrote code that looked like this:</p> <!----><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff" tabindex="0"><code><span class="line"><span style="color:#81A1C1">fn</span><span style="color:#88C0D0"> restart_server</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">ctx: </span><span style="color:#D8DEE9FF">DevContext) &#123;</span></span>
<span class="line"><span style="color:#616E88">  // kill_process is a FFI function calling process.kill("SIGTERM")</span></span>
<span class="line"><span style="color:#88C0D0">  kill_process</span><span style="color:#D8DEE9FF">(ctx.process)</span></span>
<span class="line"><span style="color:#81A1C1">  let</span><span style="color:#D8DEE9FF"> process </span><span style="color:#81A1C1">=</span><span style="color:#88C0D0"> deno_spawn</span><span style="color:#D8DEE9FF">([</span><span style="color:#A3BE8C">"gleam"</span><span style="color:#D8DEE9FF">, </span><span style="color:#A3BE8C">"dev"</span><span style="color:#D8DEE9FF">, </span><span style="color:#A3BE8C">"run"</span><span style="color:#D8DEE9FF">])</span></span>
<span class="line"><span style="color:#D8DEE9FF">  DevContext(</span><span style="color:#81A1C1">..</span><span style="color:#D8DEE9FF">ctx, process:)</span></span>
<span class="line"><span style="color:#D8DEE9FF">&#125;</span></span></code></pre><!----> <p>However, the new server could not start and threw an error saying port 1212 was not available.
But I just killed the process that used port 1212 !!! Well, not really ! <code>process.kill</code> only sends the signal “SIGTERM” to the process
which will handle it as it wants. By default, it will stop the process but this is not necessarily the case. For our process, this is
what will happen but we have to explicitely wait for the process to be stopped. Fortunately, by awaiting <code>process.status</code>, we make sure
that the process is stopped before exiting the <code>kill_process</code> function.</p> <p>Now that this is taken care of, we make use of <code>promise.await</code> to await <code>kill_process</code> before spawning the new one and
we should be good, right ? Right ?! Not quite ! Now <code>kill_process</code> runs indefinitely ! It took some time to understand what
was going on, but <code>ps -aux</code> gave me the answer:</p> <!----><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff" tabindex="0"><code><span class="line"><span>lbillaud    3086  2.0  0.1 910728 24092 pts/5    Sl+  10:48   0:00 gleam dev run watch</span></span>
<span class="line"><span>lbillaud    3100  2.6  0.4 35440224 78504 pts/5  Sl+  10:48   0:00 deno run --allow-all /home/lbillaud/rss-reader/build/dev/javascript/rss_reader/gleam.main.mjs run watch</span></span>
<span class="line"><span>lbillaud    3115  1.3  0.1 909692 21264 pts/5    Sl+  10:48   0:00 /home/linuxbrew/.linuxbrew/bin/gleam dev run</span></span>
<span class="line"><span>lbillaud    3130  1.3  0.4 35372212 73416 pts/5  Sl+  10:48   0:00 deno run --allow-all /home/lbillaud/rss-reader/build/dev/javascript/rss_reader/gleam.main.mjs run</span></span>
<span class="line"><span>lbillaud    3145  0.0  0.0   7756  3516 pts/3    R+   10:48   0:00 ps -aux</span></span></code></pre><!----> <p>Here you can see the 5 last processes launched on my machine. 4 of them correspond to my dev server. Wait, 4 !?!
The gleam command itself spawns a new process to launch the runtime that will execute the code (here deno).
So when we sent a “SIGTERM” to our process, it was sent to process n°3115 (gleam run dev) while the one we want
to receive the signal is the one running the server so process n°3130 (deno run). And it appears, sending a signal
to the gleam command does nothing. It is not forwarded, it does not kill the <code>gleam</code> process, nothing !</p> <p>To solve this issue, I decided to launch the <code>deno run</code> command myself. Now only one process is spawned and when
I send it a “SIGTERM” it does properly kill the process. Victory ? Almost !</p> <h3>Last hurdles</h3> <p>One problem with Javascript is that occasionally, functions can throw errors without you knowing it in advance
(except if they are well-documented). So every FFI function had to be wrapped in try-catch blocks and now return
a Result. Functions like <code>kill_process</code> that used to return <code>Nil</code> now have to return <code>Promise(Result(Nil, String))</code>,
but I still prefer that to not knowing exactly what will happen.</p> <p>We are almost there ! The last hurdle concerns the watcher and its events. You see, many events can be sent
for a single change. For instance, a delete and a create event will be sent if you move a file. Or if you
save multiple files at once (“:wa”), all write events will be sent at once. Since we don’t care about each
individual change, I followed the <a href="https://docs.deno.com/examples/watching_files/" rel="nofollow">Deno doc</a> and used a <code>debounce</code>d function. I also added a context object to have access to the server process in my callback
(in order to kill the process).</p> <!----><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff" tabindex="0"><code><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> &#123;</span><span style="color:#8FBCBB"> debounce</span><span style="color:#ECEFF4"> &#125;</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> '</span><span style="color:#A3BE8C">jsr:@std/async/debounce</span><span style="color:#ECEFF4">'</span><span style="color:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">export</span><span style="color:#81A1C1"> async</span><span style="color:#81A1C1"> function</span><span style="color:#88C0D0"> deno_watch</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">path</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> initialCtx</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> onEvent</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> &#123;</span></span>
<span class="line"><span style="color:#81A1C1">	let</span><span style="color:#D8DEE9"> watcher</span><span style="color:#81A1C1"> =</span><span style="color:#D8DEE9"> Deno</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">watchFs</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">path</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#81A1C1">	let</span><span style="color:#D8DEE9"> context</span><span style="color:#81A1C1"> =</span><span style="color:#D8DEE9"> initialCtx</span><span style="color:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">	const</span><span style="color:#D8DEE9"> onEventDebounced</span><span style="color:#81A1C1"> =</span><span style="color:#88C0D0"> debounce</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">onEvent</span><span style="color:#ECEFF4">,</span><span style="color:#B48EAD"> 500</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">	for</span><span style="color:#81A1C1"> await</span><span style="color:#D8DEE9FF"> (</span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9"> event</span><span style="color:#81A1C1"> of</span><span style="color:#D8DEE9"> watcher</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">&#123;</span></span>
<span class="line"><span style="color:#D8DEE9">		context</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> await</span><span style="color:#88C0D0"> onEventDebounced</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">context</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> event</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#ECEFF4">	&#125;</span></span>
<span class="line"><span style="color:#ECEFF4">&#125;</span></span></code></pre><!----> <p>Now, here is the problem: context always ended up being undefined and the process crashed. It turns out that <a href="https://jsr.io/@std/async@1.0.16/doc/~/debounce" rel="nofollow">debounce</a> expects a function returning <code>void</code> and returns a
function returning <code>void</code>. Thus, all the logic has to be taken out of the loop and put in the function passed to <code>debounce</code>.</p> <!----><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff" tabindex="0"><code><span class="line"><span style="color:#81A1C1">export</span><span style="color:#81A1C1"> async</span><span style="color:#81A1C1"> function</span><span style="color:#88C0D0"> deno_watch</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">path</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> initialCtx</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> onEvent</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> &#123;</span></span>
<span class="line"><span style="color:#81A1C1">	let</span><span style="color:#D8DEE9"> watcher</span><span style="color:#81A1C1"> =</span><span style="color:#D8DEE9"> Deno</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">watchFs</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">path</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#81A1C1">	let</span><span style="color:#D8DEE9"> context</span><span style="color:#81A1C1"> =</span><span style="color:#D8DEE9"> initialCtx</span><span style="color:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">	const</span><span style="color:#D8DEE9"> onEventDebounced</span><span style="color:#81A1C1"> =</span><span style="color:#88C0D0"> debounce</span><span style="color:#D8DEE9FF">(</span><span style="color:#81A1C1">async</span><span style="color:#ECEFF4"> (</span><span style="color:#D8DEE9">ev</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1"> =></span><span style="color:#ECEFF4"> &#123;</span></span>
<span class="line"><span style="color:#D8DEE9">		context</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> await</span><span style="color:#88C0D0"> onEvent</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">context</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> ev</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#ECEFF4">	&#125;,</span><span style="color:#B48EAD"> 500</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">	for</span><span style="color:#81A1C1"> await</span><span style="color:#D8DEE9FF"> (</span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9"> event</span><span style="color:#81A1C1"> of</span><span style="color:#D8DEE9"> watcher</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">&#123;</span></span>
<span class="line"><span style="color:#81A1C1">		await</span><span style="color:#88C0D0"> onEventDebounced</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">event</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#ECEFF4">	&#125;</span></span>
<span class="line"><span style="color:#ECEFF4">&#125;</span></span></code></pre><!----> <p>With this version, the server restart system works properly ! The final step is to reload the page automatically.</p> <h2>Reloading the page automatically</h2> <p>Since my webpage is very simple and does not have state or whatnots, I can simply reload it to get access to the
modified content. I needed a way for the client to know that the server has restarted. I thought about doing
WebSockets (which glen support) or Server-Sent Events, but those 2 solutions require a TCP connection between
the client and the server and I did not know if that would be possible since we have to <strong>restart</strong> the server.</p> <p>I ended up using a super simple solution suggested by <a href="https://chat.mistral.ai/chat" rel="nofollow">Le Chat</a>: polling.
I can simply send HTTP requests at a regular interval to the server and check if it always answers with the
same response. If the response is different, it means that the server has restarted. To implement this system,
I am sending the timestamp at which the server started when we receive a request on <code>/last-updated</code>. Finally,
I make the dev server inject a small script doing the polling in the HTML page and voilà !!!</p> <!----><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff" tabindex="0"><code><span class="line"><span style="color:#81A1C1">let</span><span style="color:#D8DEE9"> serverStartTime</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> undefined;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0">setInterval</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1"> =></span><span style="color:#ECEFF4"> &#123;</span></span>
<span class="line"><span style="color:#88C0D0">	fetch</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">'</span><span style="color:#A3BE8C">/last-updated</span><span style="color:#ECEFF4">'</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#ECEFF4">		.</span><span style="color:#88C0D0">then</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">response</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1"> =></span><span style="color:#D8DEE9"> response</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">text</span><span style="color:#D8DEE9FF">())</span></span>
<span class="line"><span style="color:#ECEFF4">		.</span><span style="color:#88C0D0">then</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">data</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1"> =></span><span style="color:#ECEFF4"> &#123;</span></span>
<span class="line"><span style="color:#81A1C1">			if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#81A1C1">!</span><span style="color:#D8DEE9">serverStartTime</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">&#123;</span></span>
<span class="line"><span style="color:#D8DEE9">				serverStartTime</span><span style="color:#81A1C1"> =</span><span style="color:#88C0D0"> parseFloat</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">data</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#ECEFF4">			&#125;</span><span style="color:#81A1C1"> else</span><span style="color:#ECEFF4"> &#123;</span></span>
<span class="line"><span style="color:#81A1C1">				const</span><span style="color:#D8DEE9"> newStartTime</span><span style="color:#81A1C1"> =</span><span style="color:#88C0D0"> parseFloat</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">data</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#81A1C1">				if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#D8DEE9">newStartTime</span><span style="color:#81A1C1"> !==</span><span style="color:#D8DEE9"> serverStartTime</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">&#123;</span></span>
<span class="line"><span style="color:#D8DEE9">					console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">'</span><span style="color:#A3BE8C">Changes detected on server. Reloading page...</span><span style="color:#ECEFF4">'</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9">					window</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">location</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">reload</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#ECEFF4">				&#125;</span></span>
<span class="line"><span style="color:#ECEFF4">			&#125;</span></span>
<span class="line"><span style="color:#ECEFF4">		&#125;</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#ECEFF4">&#125;,</span><span style="color:#B48EAD"> 1000</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></code></pre><!----> <h2>Conclusion</h2> <p>I ended up spending 2 extra days making the dev server work and writing this post compared to if I just restarted
the server manually. Was it worth it ? I would say yes ! I did learn some stuff about Deno, processes and signals.
Also now auto-reloading servers do not seem so magical to me now and more like something I had some understanding
about. Finally, my mind is not at ease knowing that I can write code and see the resulting effect the next second
and that I will never have to manually restart the server or reload the page ever again !</p> <p>I may publish the code as a library if you ask me to or you can steal it from <a href="https://github.com/Billuc/rss-reader" rel="nofollow">this repo</a> ;)</p> <p>Happy coding !</p><!----></div></article></div><!----><!----><!----></div> <div class="mx-auto mb-4 text-center w-11/12 opacity-60 text-sm">Website developped by Luc Billaud using Svelte, Vite, Tailwind, FontAwesome, Github &amp; Github
				Actions</div></div></div></div><!----></main><!----><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_jrmgwi = {
						base: new URL("..", location).pathname.slice(0, -1)
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.Z93z0FaC.js"),
						import("../_app/immutable/entry/app.BQofsKFK.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 5],
							data: [null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
